name: Release

on:
  push:
    branches: [main]
    paths:
      - "frontend/**"
      - "backend/**"
      - ".github/workflows/release.yml"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  # 1. Identify trigger & 2. Detect changes
  # On manual trigger: all outputs are true (nothing skipped)
  # On push: only changed paths are true
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.set-changes.outputs.frontend }}
      backend: ${{ steps.set-changes.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        if: github.event_name == 'push'
        id: filter
        with:
          filters: |
            frontend: frontend/**
            backend: backend/**
      - name: Set change outputs
        id: set-changes
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "frontend=true" >> "$GITHUB_OUTPUT"
            echo "backend=true" >> "$GITHUB_OUTPUT"
          else
            echo "frontend=${{ steps.filter.outputs.frontend }}" >> "$GITHUB_OUTPUT"
            echo "backend=${{ steps.filter.outputs.backend }}" >> "$GITHUB_OUTPUT"
          fi

  # 3. Build frontend
  build-frontend:
    needs: detect-changes
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - run: cd frontend && npm ci && npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: texthunter-dist
          path: frontend/dist/

  # 3.1 Notify xergiz frontend
  notify-xergiz-frontend:
    needs: [detect-changes, build-frontend]
    if: needs.detect-changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.XERGIZ_TRIGGER_TOKEN }}
          repository: XergiZ/xergiz
          event-type: product-updated
          client-payload: |
            {
              "product": "text-hunter",
              "product_id": "texthunter",
              "run_id": "${{ github.run_id }}",
              "repo": "${{ github.repository }}"
            }

  # 4. Notify xergiz backend
  notify-xergiz-backend:
    needs: detect-changes
    if: needs.detect-changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.XERGIZ_TRIGGER_TOKEN }}
          repository: XergiZ/xergiz
          event-type: product-backend-updated
          client-payload: |
            {
              "product": "text-hunter",
              "product_id": "texthunter",
              "run_id": "${{ github.run_id }}",
              "repo": "${{ github.repository }}"
            }
